Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_CA_BarterBonus((CHARACTERGUID)NULL_00000000-0000-0000-0000-000000000000, 0);
DB_CA_HighestBarter(0);
KBSECTION
//REGION QUERIES_PROCS

QRY
CA_GetHighestBarter()
AND
DB_IsPlayer(_Player)
AND
CharacterGetAbility(_Player, "Barter", _BarterVal)
AND
_BarterVal > 0
AND
DB_CA_HighestBarter(_HighestBarter)
AND
_BarterVal > _HighestBarter
THEN
NOT DB_CA_HighestBarter(_HighestBarter);
DB_CA_HighestBarter(_BarterVal);

QRY
CA_GetBarterBonus((CHARACTERGUID)_Target, (INTEGER)_TargetVal)
AND
DB_CA_HighestBarter(_HighestBarter)
AND
_HighestBarter > _TargetVal
AND 
IntegerSubtract(_HighestBarter, _TargetVal, _FinalVal)
THEN
DB_CA_BarterBonus(_Target, _FinalVal);

PROC
CA_ResetHighestBarter()
THEN
DB_CA_HighestBarter(0);
//END_REGION

//REGION MULTIPLAYER
IF
RequestTrade((CHARACTERGUID)_Target, (CHARACTERGUID)_Trader)
AND
DB_IsPlayer(_Target)
AND
DB_GlobalFlag("GLO_MultiPlayer")
AND
CA_GetHighestBarter(_Target)
AND
CharacterGetAbility(_Target, "Barter", (INTEGER)_TargetVal)
AND
CA_GetBarterBonus(_Target, _TargetVal)
AND
DB_CA_BarterBonus(_Target, _BarterBonus)
THEN
CharacterAddAbility(_Target, "Barter", _BarterBonus);
DisplayText(_Trader, "Your party's reputation proceeds you. Discounts for all.");

IF
TradeEnds((CHARACTERGUID)_Target, (CHARACTERGUID)_Trader)
AND
DB_GlobalFlag("GLO_MultiPlayer")
AND
DB_CA_BarterBonus(_Target, _BarterBonus)
THEN
CharacterRemoveAbility(_Target, "Barter", _BarterBonus);
NOT DB_CA_BarterBonus(_Target);
CA_ResetHighestBarter();

//END_REGION

//REGION SINGLEPLAYER
IF
RequestTrade((CHARACTERGUID)_Target, (CHARACTERGUID)_Trader)
AND
NOT DB_GlobalFlag("GLO_MultiPlayer")
AND
CA_GetHighestBarter()
AND
DB_IsPlayer(_Player)
AND
CharacterGetAbility(_Player, "Barter", (INTEGER)_PlayerVal)
AND
CA_GetBarterBonus(_Player, _PlayerVal)
AND
DB_CA_BarterBonus(_Player, _BarterBonus)
THEN
CharacterAddAbility(_Player, "Barter", _BarterBonus);

IF
TradeEnds((CHARACTERGUID)_Target, (CHARACTERGUID)_Trader)
AND
NOT DB_GlobalFlag("GLO_MultiPlayer")
AND
DB_CA_BarterBonus(_Player, _BarterBonus)
THEN
CharacterRemoveAbility(_Player, "Barter", _BarterBonus);
NOT DB_CA_BarterBonus(_Player);
CA_ResetHighestBarter();
//END_REGION

//REGION DEBUG
IF
DialogStarted((STRING)_Dialog, (INTEGER)_ID)
AND
DialogGetInvolvedPlayer(_ID, 1, (CHARACTERGUID)_Player)
AND
DialogGetInvolvedNPC(_ID, 1, (CHARACTERGUID)_Trader)
AND
DB_IsPlayer(_Player)
AND
DB_GlobalFlag("GLO_MultiPlayer")
THEN
CharacterStatusText(_Trader, "You're playing multiplayer.");

IF
DialogStarted((STRING)_Dialog, (INTEGER)_ID)
AND
DialogGetInvolvedPlayer(_ID, 1, (CHARACTERGUID)_Player)
AND
DialogGetInvolvedNPC(_ID, 1, (CHARACTERGUID)_Trader)
AND
DB_IsPlayer(_Player)
AND
NOT DB_GlobalFlag("GLO_MultiPlayer")
THEN
CharacterStatusText(_Trader, "You're offline.");
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ZZ_CivilAuras"
