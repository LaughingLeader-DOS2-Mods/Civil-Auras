Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_CA_BarterBonus((CHARACTERGUID)NULL_00000000-0000-0000-0000-000000000000, 0);
KBSECTION
QRY
CA_GetHighestBarter((CHARACTERGUID)_Target, (INTEGER)_TargetVal)
AND
DB_IsPlayer(_Player)
AND
_Player!=_Target 
AND
CharacterGetAbility(_Player, "Barter", _BarterVal)
AND
_BarterVal > 0
AND
_BarterVal > _TargetVal
AND
IntegerSubtract(_BarterVal, _TargetVal, _FinalVal)
THEN
DB_CA_BarterBonus(_Target, _FinalVal);

QRY
QRY_CA_GetPlayers((STRING)_Message)
AND
DB_IsPlayer(_Player)
AND
GetUUID(_Player, _Name)
AND
StringConcatenate(_Message, _Name, (STRING)_OutputMessage)
AND
StringConcatenate(_OutputMessage, ",", _OutputMessage)
THEN
DB_CA_TestLog(_OutputMessage, "Message");
DB_NOOP(1);

/*
IF
RequestTrade((CHARACTERGUID)_Target, (CHARACTERGUID)_Trader)
AND
QRY_CA_GetPlayers("Players: ")
AND
DB_CA_TestLog(_Message, "Message")
THEN
DisplayText(_Target, _Message);
*/

IF
RequestTrade((CHARACTERGUID)_Target, (CHARACTERGUID)_Trader)
AND
CharacterGetAbility(_Target, "Barter", (INTEGER)_TargetVal)
AND
CA_GetHighestBarter(_Target, _TargetVal)
AND
DB_CA_BarterBonus(_Target, _BarterBonus)
THEN
CharacterAddAbility(_Target, "Barter", _BarterBonus);
DisplayText(_Trader, "Your party's reputation proceeds you. Discounts for all.");

IF
TradeEnds((CHARACTERGUID)_Target, (CHARACTERGUID)_Trader)
AND
DB_CA_BarterBonus(_Target, _BarterBonus)
THEN
CharacterRemoveAbility(_Target, "Barter", _BarterBonus);
NOT DB_CA_BarterBonus(_Target);
//DisplayText(_Trader, "Goodbye.");
EXITSECTION

ENDEXITSECTION
